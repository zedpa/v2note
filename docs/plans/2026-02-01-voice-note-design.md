# 语音笔记 App 设计草案（Flutter + Supabase + 云端 ASR + OpenAI）

日期：2026-02-01

## 目标与核心体验
- 通过“摇一摇开始录音、挂机键结束”快速采集语音。
- 云端转写中英混合语音，并自动生成：摘要、标签、to-do、idea。
- 时间线 UI 类似 Twitter 发布流，卡片以“自动生成内容”为主。
- 每周自动生成回顾，通过推送通知提醒，点击查看周报详情。

## 范围与约束
- 客户端：Flutter 跨端（iOS/Android）。
- 语音识别：云端 ASR（中英混合）。
- 语义处理：OpenAI API（摘要/标签/待办/想法提取）。
- 数据：本地优先缓存 + 可选云端同步（Supabase）。
- 后台能力：允许长时间后台录音 + 实时转写（需合规提示与降级策略）。

## 关键假设
- 用户可接受云端处理音频及文本。
- 允许使用推送服务进行周报提醒。
- 录音、后台任务、推送在 iOS/Android 均可满足基本可用（有降级预案）。

## 架构总览
客户端 Flutter 负责录音控制、摇一摇检测、上传队列与 UI 展示。录音完成后上传音频到 Supabase Storage，并写入处理任务记录。后端 Worker/Edge Function 拉取任务，调用云端 ASR 得到转写，再调用 OpenAI 提取结构化内容，写回 Supabase Postgres。客户端通过 Realtime 或轮询拉取增量更新。

```
Flutter App
  -> Supabase Storage (audio)
  -> Supabase DB (task)
      -> Worker/Edge Function
          -> ASR API -> transcript
          -> OpenAI API -> summary/tags/todos/ideas
  <- Supabase DB (records)
```

## 客户端模块划分
1. 录音与权限模块
   - 前后台录音控制、分段、压缩（如 AAC/Opus）。
   - 权限引导与设置入口（可随时关闭后台录音）。
2. 摇一摇检测模块
   - 触发开始录音。
   - “挂机键”结束录音。
3. 上传与队列模块
   - 本地队列缓存与重试。
   - 弱网断网自动恢复。
4. 时间线与详情模块
   - 卡片显示：时间、摘要、标签、to-do、idea。
   - 详情显示：原始转写、编辑标签/待办状态。
5. 周报与推送模块
   - 周报摘要展示。
   - 推送提醒与深链跳转。
6. 设置与隐私模块
   - 后台录音开关。
   - 音频保留策略设置与手动删除。

## 后端与数据模型
建议实体：
- record：一次录音的主记录（时间、设备、状态、音频路径）。
- transcript：转写文本（语言、置信度、段落）。
- summary：摘要（短/长）。
- tag：标签（多对多）。
- todo：待办项（完成状态、优先级、截止时间可选）。
- idea：想法条目。
- weekly_review：周报（时间范围、摘要、统计）。

关系示例：
- record 1..1 transcript
- record 1..1 summary
- record 1..N todo
- record 1..N idea
- record N..N tag

## 核心流程
### 录音与处理
1) 摇一摇开始录音。
2) 用户按挂机键结束。
3) 客户端上传音频，写入任务记录。
4) 后端调用 ASR -> transcript。
5) 调用 OpenAI -> summary/tags/todos/ideas。
6) 写回 DB，客户端刷新时间线。

### 周报
1) 每周定时任务汇总 record/todo 完成情况。
2) 调用 OpenAI 生成周报摘要。
3) 写入 weekly_review 并推送通知。

## 错误处理与降级策略
- 录音权限失败：提示并引导设置。
- 后台限制：自动降级为“前台录音 + 后台处理”。
- ASR 失败：重试；保留音频，标记“待转写”。
- OpenAI 失败：保留转写，标记“待总结”。
- 网络失败：上传队列缓存，联网后自动恢复。

## 隐私与合规
- 明确告知后台录音，用户需显式同意。
- 默认音频短期保留（如 7 天），可一键删除。
- 支持关闭后台录音与音频上传。

## 测试策略
- 单元测试：录音状态机、队列重试、数据映射。
- 集成测试：上传->转写->摘要流程；断网恢复；多设备同步。
- 端到端测试：摇一摇录音、后台切换、周报推送。

## 风险与缓解
- iOS 后台录音限制：提供降级模式与明确提示。
- 成本与配额：按时长/次数限额，后续可分级套餐。
- 中英混合识别质量：ASR 供应商评测与切换预案。

## 里程碑建议（MVP）
1) 录音 + 上传 + 转写。
2) OpenAI 结构化输出 + 时间线。
3) 周报生成 + 推送。
4) 本地缓存 + 同步优化。

---

如需进入实现阶段：下一步应使用 superpowers:using-git-worktrees 与 superpowers:writing-plans。
